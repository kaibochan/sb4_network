local scan = {}

function scan.get_drives()
    all_drives = {}

    names = peripheral.getNames()
    for _, name in ipairs(names) do
        p_type = peripheral.getType(name)
        if p_type == "drive" then
            table.insert(all_drives, peripheral.wrap(name))
        end
    end

    return all_drives
end

function scan.get_mount_paths(drives)
    all_mount_paths = {}

    for _, drive in ipairs(drives) do
        table.insert(all_mount_paths, drive.getMountPath())
    end

    return all_mount_paths
end

function scan.find_files(network_paths)
    network_files = {}

    frontier = {}
    for _, path in ipairs(network_paths) do
        table.insert(frontier, path)
    end

    while #frontier ~= 0 do
        for _, f in ipairs(fs.list(frontier[1])) do
            f_path = frontier[1].."/"..f
            if fs.isDir(f_path) then
                table.insert(frontier, f_path)
            else
                table.insert(network_files, f_path)
            end
        end

        table.remove(frontier, 1)
    end

    return network_files
end

local function get_words_in(file_path)
    words = {}
    for line in io.lines(file_path) do
        for word in line:gmatch("[%w]+") do
            table.insert(words, word:lower())
        end
    end
    return words
end

function scan.index_files(files)
    index = {}

    for file in files do
        for word in get_words_in(file) do
            if ~index[word] then
                table.insert(index, word, {})
            end
            table.insert(index[word], file)
        end
    end

    return index
end

function main()
    drives = scan.get_drives()
    paths = scan.get_mount_paths(drives)
    
    files = scan.find_files(paths)
    index = scan.index_files(files)

    print(textutils.serialise(index))
    -- for _, file in ipairs(files) do
    --     print(file)
    -- end
end

main()

return scan